# Nimipalvelu ja domain

Ostin domainin omalle nimelleni [paulcarlson.fi](http://paulcarlson.fi) suomalaisesta palvelusta [bittivirta.fi](http://bittivirta.fi):stä, koska paulcarlson.com ei ollut vapaana ja NameCheap ei tarjoa .fi -tunnuksia. Pelkkä domaini oli 16€/vuosi, ja ihmettelin aluksi kun en löytänyt mitään paikkaa missä hallinnoida siihen ohjattavaa IP-osoitetta (A-tietueet). Pienen selvittelyn jälkeen tajusin, että heillä on erillinen palvelu WebHotelli (onneksi maksuton domainin omistajalle), jonka sitten otin kylkiäiseksi. Toivottavasti sieltä pääsee muokkaamaan asetuksia.

Webhotellin tilauksen käsittelyssä kesti kuitenkin seuraavaan päivään, eli en heti päässyt jatkamaan tehtävää. Kun sain viestin, että Uusi webhotellisi paulcarlson.fi on asennettu, kävin heti katsomassa miltä omassa domainissani nyt näyttää:

<img width="1920" height="1030" alt="image" src="https://github.com/user-attachments/assets/29b7b63a-5b85-4108-b053-f1011c844a42" />

Domaini ainakin toimii nyt, mutta ei siten kuten haluttiin eli linkattuna omaan virtuaalipalvelimeeni Hetzneriltä. Katson vielä `curl`-komennolla, mitä osoitteesta paulcarlson.fi vastataan.

<img width="997" height="253" alt="image" src="https://github.com/user-attachments/assets/3c9dc85b-3f18-46bf-a484-7b68a6a0397c" />

Jännä vastaus: ei vastaa ollenkaan sitä mitä selain näyttää. Toiselta kurssilta olin juuri oppinut, että webbisivut saattavat ennen vastauksen antamista haistella, kuka onkaan tehnyt pyynnön, ja antaa eri vastauksen eri pyytäjille. Esim. `curl` -pyynnölle ei anneta samaa HTML-sivua vastauksena kuin selaimelle. Toinen vinkki oli, että mm. Firefox-selaimella voi kopioida pyynnön headerit suoraan `curl`:n käytettävässä muodossa, ja siten terminaalista käsin tehdä pyyntöjä jotka vastaavat selaimella tehtyjä:

<img width="966" height="622" alt="image" src="https://github.com/user-attachments/assets/9b8998f7-2b4c-4bec-9b16-734667729269" />

Eli Firefoxin dev-tools auki F12-nappulalla ja sieltä network-tabista valitaan ylimmäinen GET-pyyntö webbisivun juurihakemistoon. Liitin kopioidun `curl`-pyynnön terminaaliin:

<img width="957" height="424" alt="image" src="https://github.com/user-attachments/assets/374d36d0-5fcc-4ef3-9580-a17b545e1a79" />

<img width="1037" height="709" alt="image" src="https://github.com/user-attachments/assets/dcc146f6-08c3-4115-bd2e-29726cfc582d" />

Vastauksena tullut html-koodi näytti nyt erilaiselta, ja sisältää javascriptiä, jolla oletussivu on oletettavasti luotu.

Tsekataan vielä mikä IP-osoite sivun taustalla on tällä hetkellä:

<img width="957" height="272" alt="image" src="https://github.com/user-attachments/assets/9ac495bc-45e2-4b95-bdca-90423f3d019f" />

IP: `95.217.166.192`

Seuraavaksi lähdin selvittämään, kuinka siirtää bittivirran asetussivuilta tuohon tilalle oman Hetzneriltä ostetun palvelimeni IP-osoite `65.109.175.125`, eli A-tietueiden asetus edessä.

Kirjauduin bittivirran portaaliin `portal.bittivirta.fi` ja sieltä valitsin `Verkkotunnus` ja `Hallitse verkkotunnuksia`. Selain avasi toisen hallinnointiportaalin `Plesk`:n:

<img width="1743" height="845" alt="image" src="https://github.com/user-attachments/assets/b8a6f480-f442-42da-b78f-bd11f4cab654" />

Nyt näyttää lupaavalta, täällähän voi hallinnoida vaikka mitä! Mutta ainoa asia mikä nyt alkuun kiinnostaa, on paikka editoida A-tietueita. Isännöinti ja DNS -välilehdeltä löytyvä DNS-kuvake vaikutti hyvältä paikalta aloittaa.

<img width="1439" height="946" alt="image" src="https://github.com/user-attachments/assets/a3851be1-f824-4983-8609-aed53285a9ec" />

Alimpana listassa loistaa Tietuetyyppi `A` ja sama IP-osoite kuin sain selvitettyä `curl`:lla! Eli kaiken järjen mukaan ei tarvtsisi muutakuin vaihtaa tuohon IP-osoite osoittamaan mun palvelimeen.

<img width="684" height="459" alt="image" src="https://github.com/user-attachments/assets/041137fc-6001-4352-8641-212917615f8b" />

Noin!

<img width="1520" height="190" alt="image" src="https://github.com/user-attachments/assets/aa20489f-92c6-44b7-9e27-be1dbd4af528" />

Tällainen varoitus vielä popsahti eteen, kokeillaan vastata `Päivitä`.

<img width="1181" height="395" alt="image" src="https://github.com/user-attachments/assets/a4e7bbe9-fc75-4706-934b-987b034ae215" />

Jahas. Taasko on odotettava seuraavaan päivään. Linkistä klikkaamalla saa vielä lisäohjeita:

<img width="698" height="638" alt="image" src="https://github.com/user-attachments/assets/3bdc6936-2138-4137-aa48-a0cdf144764b" />

Kokeillaanpa poistaa kaikki tietueet ja lähteä puhtaalta pöydältä:

<img width="1158" height="513" alt="image" src="https://github.com/user-attachments/assets/2b8e03f6-24aa-45d8-a81c-a8a956ca7a4f" />

Toimisko näillä:

<img width="1236" height="812" alt="image" src="https://github.com/user-attachments/assets/7a90cb61-5772-4cd6-96b0-999daf987028" />

Ei mitään muutosta navigoidessa webbisivulle. Odotin sitten seuraavaan päivään, josko muutoksen päivittymisessä kestäisi tuo jopa 24h.

Seuraavana päivänä kokeilin kännykän selaimella ja webbisivu oli päivittynyt palvelimen sivuun!

<img width="884" height="337" alt="kuva" src="https://github.com/user-attachments/assets/04abee76-0647-4a0d-9bdf-e991eff74784" />

`nslookup` työkalu näytti myös, että IP-osoite on vaihtunut sekä www-aladomainille, että itse päädomainille:

<img width="1037" height="443" alt="kuva" src="https://github.com/user-attachments/assets/7d644782-e3fa-445a-87a0-eba652716ccf" />

~~Seuraavaksi lähden asettamaan SSL-suojausta.~~ Eipäs sittenkään, SSL-suojaus onkin ensi viikon tehtävänä. Edetään tehtävänannon mukaan ja lähden luomaan alidomaineja.

# Alidomainit

Toivottavasti alidomainien pävittymistä ei joudu odottelemaan taas päivän verran. No pian nähdään. Loin ensiksi uuden A-tietueen:

`sanuli.paulcarlson.fi.	`, TTL 300 seconds, record type: A, ip-address:	65.109.175.125.

Ajatuksena olisi laittaa toisella kurssilla juuri luotu Docker-kontti [sanuli-pelistä](https://sanuli.fi/) yhdeksi alidomainiksi omalle palvelimelle. Kokeilen ensin selaimella [sanuli.paulcarlson.fi](http://sanuli.paulcarlson.fi/):

<img width="892" height="296" alt="kuva" src="https://github.com/user-attachments/assets/c5b660e2-3b7b-4013-83a6-52756254c518" />

Se näyttäisi nyt ohjaavan pääsivulle. Vrt. esim. [kikkare.paulcarlson.fi](http://kikkare.paulcarlson.fi/), mikä valittaa Server Not Found.

<img width="961" height="1040" alt="kuva" src="https://github.com/user-attachments/assets/ffa56070-bf1f-4dde-be1e-2c821f480f3f" />

Loin toisen alidomainin CNAME-tietuetta käyttämällä:
<img width="661" height="347" alt="kuva" src="https://github.com/user-attachments/assets/3c5a6754-e375-4250-a077-7123433c219a" />

Nyt [home.paulcarlson.fi](http://home.paulcarlson.fi/) ohjaa sekin pääsivulle, mutta esimerkiksi palvelimen IP-osoitteen vaihtuessa tätä alidoimainin asetusta ei tarvitse enää käydä muuttamassa, koska se toimii ikäänkuin aliaksena.

## Sanuli-peli tulille

Sanuli on Jaakko Husson luoma suomenkielinen versio suositusta Wordle-sanapelistä. Sanuli on vapaasti ladattavissa ja jaettavissa MIT lisenssillä, ja sen lähdekoodi ja avuliaat ohjeet sen rakentamiseen löytyy täältä https://github.com/Cadiac/sanuli/tree/master.

Loin ensin kansion minne voin laittaa sanuli-alidomainin html-sivun:

<img width="1236" height="233" alt="kuva" src="https://github.com/user-attachments/assets/8634440a-2381-40af-af7e-1a6f8fa875e9" />

Ja sille conffi-tiedoston:

<img width="897" height="225" alt="kuva" src="https://github.com/user-attachments/assets/8fef25b1-00a1-4513-a25a-d73996909df7" />

Sivu päälle `sudo a2ensite sanuli.paulcarlson.fi` ja `sudo systemctl reload apache2`. 

Forbidden. No höh. Voisiko olla, että koska laitoin alidomainin webbisivun `/var/www/` hakemistosta toiseen hakemistoon, kotihakemistoni alle `/home/phool/publicsites/`, apachella ei ole sinne oikeuksia? Laitetaanpa sille niitä:

<img width="1024" height="63" alt="kuva" src="https://github.com/user-attachments/assets/594d8553-4404-4f9d-ac25-93ff4657d8a9" />

Apachen ja muiden webbiohjelmien, kuten nginx:n käyttäjä on `www-data` (lähde: https://askubuntu.com/questions/873839/what-is-the-www-data-user), jolle voi antaa rajoitetusti execute-oikeuden kansioihin, jotta se pääsee hakemaan niistä html-tiedostot näytettäviksi webbisivuille. `setfacl` -komennolla oikeuksia voi antaa käyttäjäkohtaisesti, ja `getfacl` -komennolla puolestaan näkee, keillä kaikilla on oikeuksia ja mitä oikeuksia tarkalleen (lähde: https://www.redhat.com/en/blog/access-control-lists). Alla muutama esimerkki niiden käytöstä:

<img width="1256" height="669" alt="kuva" src="https://github.com/user-attachments/assets/0294ea75-5b84-4e68-9806-b71367a7fce0" />

Laitoin oikeudet myös `sanuli.paulcarlson.fi` kansiolle, ja käynnistin apache2:n uudelleen. Kokeillaan nyt navigoida sivulle:

<img width="891" height="130" alt="kuva" src="https://github.com/user-attachments/assets/a0b06dc3-7e39-4d76-80fa-73226af606df" />

Nyt näkyy oikea sivu! Hassua, miten ääkköset taipuvat aivan kummaan muotoon. Olisiko jotain tekemistä merkistöjen kanssa? No joka tapauksessa tuohon ei ole tarkoituskaan jäädä tavallista html-sivua kansiossa, vaan nginx:n tarjoama javascript-sivu sanuli-pelin pelaamista varten. Etenen siihen seuraavaksi. Ensimmäisenä Docker-ohjelman asentaminen.

## Sivujuonne - Dockerin asentaminen Debianiin

Tämän olin jo tehnyt aiemmin, mutta en ottanut silloin kuvankaappauksia. Selvitän tähän kuitenkin terminaalin historian (`history | grep docker`) avulla, mitä silloin tuli tehtyä parhaani mukaan. 

Dockerilla oli erikseen ohjeet [Dockerin asentamiseen Debianille dockerdocks-sivustolla](https://docs.docker.com/engine/install/debian/#install-using-the-repository). Käytin `apt-repositorio` -ohjetta, jossa ensin lisätään apt-repositoriolle lähteet, mistä dockerin uusin versio löytyy. Eli kopsasin listatut komennot tekstitiedostoon `install-docker.sh`, lisäsin tekstitiedoston ylimmälle riville hash-bangin `#!/bin/bash` kertomaan, että käytä `bash`-komentotulkkia, ja ajoin komennot suoraan tiedostosta `./install-docker.sh`. Lopuksi piti ajaa itse asennuskomennot: `sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin`, ja apt-get osaa käyttää uusia asetettuja lähteitä dockerin ohjelmien lataamiseen ja asentamiseen.

----

Syksyn 2025 DevOps-kurssilla olimme kukin rakentaneet sanuli-äpin suoraan lähdekoodista Docker imageksi ja ladanneet sen docker-hubiin (https://hub.docker.com/repository/docker/phoolis/sanuli/general), ja nyt sen asentaminen ja ajaminen suoraan palvelimelle käy yhdellä komennolla:

`sudo docker run -d --name sanuli -p 127.0.0.1:8081:80 phoolis/sanuli`

`docker ps` -komento näyttää mitä kontteja on juuri nyt ajossa:

<img width="1135" height="114" alt="kuva" src="https://github.com/user-attachments/assets/6fcad7fb-0544-4335-b3e7-acb0c050f8cd" />

Ja näyttää nyt tältä, kun katsoo mitä palvelimen `localhost:8081` -osoitteesta löytyy:

<img width="999" height="382" alt="kuva" src="https://github.com/user-attachments/assets/1f3b80fc-88b9-4e37-8f9a-f352763717c7" />

Jotain javascriptiä sieltä tulee ja sanuli-nimi mainittu, näyttää lupaavalta.

Seuraavaksi täytyi muuttaa `sanuli.paulcarlson.fi.conf` -filuun html-juuripolun sijaan nginx:n reverse-proxy asetukset seuraaviksi:

<img width="959" height="241" alt="kuva" src="https://github.com/user-attachments/assets/21ce08c4-5a7c-41c3-bc7a-cb603d60feef" />

Eli tässä ohjataan `sanuli.paulcarlson.fi `-osoitteeseen tulleet pyynnöt (`"/"`, juuri) palvelimen localhost:8081 -osoitteeseen, jonne docker-kontin sisältö näytetään. Testataan `curl`:lla:

<img width="1063" height="490" alt="kuva" src="https://github.com/user-attachments/assets/648001f7-891f-4fbe-8629-da7a81e89a8e" />

Jes! Sinne näyttäisi tulevan nyt saman näköistä sisältöä kuin `localhost:8081` -osoitteeseen. Tosin selaimella navigoidessa näkyy tyhjä valkoinen sivu, ja jotain virheilmoituksia dev-konsolissa:

<img width="1616" height="609" alt="kuva" src="https://github.com/user-attachments/assets/9b997879-4f77-4e7a-9f8a-695136ec3b5c" />

Tässä vaiheessa otin ChatGPT:n debuggauskaveriksi, ja annoin sille tekemäni speksit sekä virheilmoitukset. Ensimmäinen vastaus oli hölynpölyä asetuksista, jotka minulla jo oli tehtynä, tai liian hankala ehdotus koko sovelluksen uudelleenrakentamisesta. Päätin vielä katsoa sivua uudelleen kun javascript on pois päältä, eli firefoxissa näin:

<img width="1392" height="768" alt="kuva" src="https://github.com/user-attachments/assets/05527c33-b9eb-450d-aed1-bce0a0511806" />

Nyt alkoi tulla selkeämpiä virheilmoituksia: eli HTTP 500, tarkemmin Proxy error:

<img width="1081" height="257" alt="kuva" src="https://github.com/user-attachments/assets/79a6826f-b08f-4429-a35a-0f44cc742c4b" />

Tuostakaan ei itselle heti auennut, mistä vika voisi johtua, mutta ChatGPT-huomasi puuttuvat kenoviivan osoitteen polusta `localhost:8081` ja `styles-...` kohtien väliltä:

Yritettiin hakea: `localhost:8081styles-adca7465621429ba.css`

Kun pitäisi olla: `localhost:8081/styles-adca7465621429ba.css`

Olin siis unohtanut laittaa conffi-tiedostossa kenoviivat proxy-asetukssissa `http://localhost:8081` -polun loppuun, (näitä on käynyt ennenkin):

Oli virheellisesti näin:

    ProxyPass        "/" "http://localhost:8081"
    ProxyPassReverse "/" "http://localhost:8081"

Kun piti olla:

    ProxyPass        "/" "http://localhost:8081/"
    ProxyPassReverse "/" "http://localhost:8081/"

Lisäsin puuttuvat kenoviivat, restarttasin apachen, ja a vot, sanulihan se siellä!

<img width="634" height="961" alt="kuva" src="https://github.com/user-attachments/assets/f1ab3f0b-c2db-48ba-82f5-729ba62e2df8" />

Voit nyt itsekin käydä kokeilemassa pelaamassa sanulia osoitteessa http://sanuli.paulcarlson.fi.
