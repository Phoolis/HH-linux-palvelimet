# Verkkosivun salaus

Termistöä [Cloufdlaren What is SSL | SSL definition](https://www.cloudflare.com/learning/ssl/what-is-ssl/) -sivulta: 

- SSL = Secure Sockets Layer
  - vanhempi protokolla
- TSL = Transport Layer Security
  - nykyään käytössä
- HTTPS = TSL salattu HTTP

Silti sanotaan usein SSL kun tarkoitetaan TSL, nimi on juurtunut.

Sitten tiivistelmiin.

[Let's Encrypt - How it Works](https://letsencrypt.org/how-it-works/)
- Automatisoi domainin HTTPS-sertifioinnin
- Käyttää ACME-protokollaa maantiekiitäjän nappaa... eikun sertifikaatin luomiseen
- Julkisen avaimen salausta käytetään domainin testaamiseen:
  - Haastaa webbiservun esim. julkaisemaan tietyn koodin domainin alla -> todiste, että sertifikoinnin pyytäjällä on domain hallussaan
  - Useita haasteita eri lähteistä, jotta pyyntöä ei voi kaapata valheellisesti (haasteethan tapahtuvat salaamattoman http-yhteyden kautta, koska https ei ole vielä käytössä)
  - Jos haastet onnistuvat, Let's Encrypt CA (certificate authority) antaa domainin generoidulle julkiselle avaimelle sertifikaatin
  - Sertifikaatti jaetaan vielä julkisesti usealle Certificate Transparency (CT) lokille
- Sertifikaattiketju: pari isoa juuri sertifikaattia autorisoi alempia vasallisertifikaatteja, jotka sertifioivat taas alemmas, ja selain kun luottaa tähän ketjuun, luottaa myös uuden palvelimen sertifikaattiin vaikkei olisi sitä ikinä ennen nähnyt

[Apache.org - SSL/TSL Strong Encryption: How-To](https://httpd.apache.org/docs/2.4/ssl/ssl_howto.html#configexample)
- Minimiconffi:
```
<VirtualHost *:443>
    ServerName www.example.com
    SSLEngine on
    SSLCertificateFile "/path/to/www.example.com.cert"
    SSLCertificateKeyFile "/path/to/www.example.com.key"
</VirtualHost>
```

SSL päälle Name-Based Virtual Hostiin certbotin avulla yksinkertaisuudessaan:

Reikä tulimuuriin:

`sudo ufw allow 443/tcp`

<img width="589" height="495" alt="image" src="https://github.com/user-attachments/assets/80394202-51b8-4ada-b96a-af6248e98ee7" />

Asenna certbot:

`sudo apt-get install certbot python3-certbot-apache`

<img width="989" height="59" alt="image" src="https://github.com/user-attachments/assets/63d682b7-d978-4b09-ad0f-39daedc11f6b" />

Olipa muuten kätevää käyttää tabua, kun kirjoitti tuota komentoa. python3-cer `-TAB-` näyttää mitä on saatavilla repositoriosta:

<img width="946" height="130" alt="image" src="https://github.com/user-attachments/assets/df5f1095-6467-46d2-a5db-b7334a31dd94" />

Sertifioi valitut domainit:

`sudo certbot --apache --domains example.com,www.example.com`

<img width="1166" height="609" alt="image" src="https://github.com/user-attachments/assets/d6234c3e-55e9-4bed-82aa-4a439bb511c5" />

<img width="693" height="174" alt="image" src="https://github.com/user-attachments/assets/cbecc3a7-69fe-4277-b23f-98788fef1476" />

<img width="678" height="149" alt="image" src="https://github.com/user-attachments/assets/adbf54f5-3d96-453b-8240-446e38996c70" />

Ja siellähän se himoittu lukonkuva loistaa!

Ja conffi `/etc/apache2/sites-available/paulcarlson.fi.conf` näyttää certbotin jäljiltä tältä:

```
<VirtualHost *:80>
    ServerName paulcarlson.fi
    ServerAlias www.paulcarlson.fi
    
    DocumentRoot /home/deploy/publicsites/paulcarlson.fi/

    <Directory /home/deploy/publicsites/paulcarlson.fi/>
        Require all granted
    </Directory>
RewriteEngine on
RewriteCond %{SERVER_NAME} =www.paulcarlson.fi [OR]
RewriteCond %{SERVER_NAME} =paulcarlson.fi
RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>
```

Lisäksi kansiossa on nyt ssl-conffi `paulcarlson.fi-le-ssl.conf`:

```
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName paulcarlson.fi
    ServerAlias www.paulcarlson.fi
    
    DocumentRoot /home/deploy/publicsites/paulcarlson.fi/

    <Directory /home/deploy/publicsites/paulcarlson.fi/>
        Require all granted
    </Directory>

Include /etc/letsencrypt/options-ssl-apache.conf
SSLCertificateFile /etc/letsencrypt/live/paulcarlson.fi/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/paulcarlson.fi/privkey.pem
</VirtualHost>
</IfModule>
```

## SSH sanuliin

Dokumentoin [sanulin asentamista alidomainiin tehtävässä h5](https://github.com/Phoolis/HH-linux-palvelimet/blob/main/h5.md#sanuli-peli-tulille-alidomainiin). Mitenhän käy sanuli.paulcarlson.fi:n kanssa, kun sen conffi näyttää avain erilaiselta Nginx-käänteisvälityspalvelimen takia:

```
<VirtualHost *:80>
	ServerName sanuli.paulcarlson.fi
	ServerAlias www.sanuli.paulcarlson.fi
	
	# Nginx reverse-proxy settings
	ProxyPass		"/"	"http://localhost:8081/"
	ProxyPassReverse	"/"	"http://localhost:8081/"	

</VirtualHost>
```

Sormet ristiin ja `sudo certbot --apache --domains sanuli.paulcarlson.fi`.

Terminaaliin ainakin tulostuu toiveikkaan näköistä litaniaa:

<img width="1132" height="417" alt="image" src="https://github.com/user-attachments/assets/c55a4fb3-98db-4178-99f9-970fabcdbdab" />

Entäs webbisivu itse?

<img width="666" height="93" alt="image" src="https://github.com/user-attachments/assets/11340d90-3b61-4a29-b59d-08b1b3c76094" />

Halleluja, heittämällä läpi! Samanlaiset muutokset tuli tuohonkin conffiin:

<img width="1043" height="590" alt="image" src="https://github.com/user-attachments/assets/e1b790d3-dcc1-4924-bbae-a6c0d1121222" />

Kokeillaan lisätä tuo arvokas `s` myös webbisivun `sanuli.paulcarlson.fi` linkkiin:

<img width="751" height="318" alt="image" src="https://github.com/user-attachments/assets/9b5fe5c0-368f-4e88-a118-40e362eeef0f" />

<img width="857" height="739" alt="image" src="https://github.com/user-attachments/assets/0c5d3496-accd-43bf-891e-8033b6126901" />

Hmm. Workflow successful, mutta huolestuttavan näköisiä varoituksia kun käy katsomassa tarkemmin. Eikä sitä korvaamatonta `s`:ää tullut vielä linkkiin.

Kysyin apua ChatGPT:ltä, jonka mukaan git voi hermostua, jos repon kansiolla on monta omistajaa ja eri luoja kuin omistaja. Kokeillaan tuota ehdotettua komentoa:

`sudo git config --system --add safe.directory /home/deploy/publicsites/paulcarlson.fi`

Sitten pieni muutos README.md tiedostoon ja uusi yritys:

<img width="842" height="324" alt="image" src="https://github.com/user-attachments/assets/b0bc41eb-4c23-405a-9dd4-59eb3e504850" />

Nyt näyttää paremmalta. Firefoxin Inspect näyttää myös, että https on nyt lisätty linkkiin: <img width="296" height="108" alt="image" src="https://github.com/user-attachments/assets/0825afa8-0c77-41d6-b22a-32f765e277dd" />

## SSL Labs Server test

<img width="1118" height="677" alt="image" src="https://github.com/user-attachments/assets/73769181-2b4e-48ed-b9bc-8bfc9d718756" />

Paras S-ryh... eikun A-ryhmä!

----

Luin toisen kurssilaisen, [Janne Narisen raporttia](https://github.com/narinojanne/linux-homeworks/blob/main/h6-salataampa.md), josta löytyi hyvä vihje CAA-policyn (Certification Authority Authorization) asettamisesta domainiin. Näin ainoastaan CAA-policyssä mainittu CA voi myöntää domainille SSL-salauksen mahdollistavan sertifikaatin.

Kävin asettamassa bittivirta.fi:n portaalissa CAA asetukset paulcarlson.fi, ja sen alidomaineihin:

<img width="833" height="474" alt="image" src="https://github.com/user-attachments/assets/3acb292e-2dec-4155-a327-e5f6fa4c1fa0" />

<img width="733" height="119" alt="image" src="https://github.com/user-attachments/assets/7f40595d-0e75-4401-89aa-ea23757358d1" />

Muutaman minuutin päästä Kokeilin SSL Labsin testiä uudelleen (clear cache välissä!). <img width="529" height="71" alt="image" src="https://github.com/user-attachments/assets/cc4b8d5c-f0f6-4185-bf5b-7fd1f70f6214" />

<img width="613" height="163" alt="image" src="https://github.com/user-attachments/assets/b9e3ed05-8a43-49a5-bbb9-f023966f5d7a" />

Edelleen sanoo "No" `DNS CAA`-kohdassa. Täytyykö tällä palveluntarjoajalla tosiaankin AINA odottaa seuraavaan päivään jokaista DNS-asetusta!? Pikkasen harmittaa nyt kun menin valitsemaan tämän laadukkaan Suomalaisen palvelun sen suositellun NameCheap.com:n sijasta.

No ei auta kuin odotella. Voisin ajaa tuon testin aina parin tunnin välein noin kokeilumielessä.

Kävin vielä tarkastamassa `dig`-komennolla, onko CAA-sertifikaattia:

<img width="797" height="373" alt="image" src="https://github.com/user-attachments/assets/57f219dd-a245-40f1-b9aa-13a0ed284438" />

Siellähän se näkyisi olevan jo. Minkähän takia sitä ei sitten näy SSL Labsin testissä?

Kokeilin vielä www-alidomainille, ja sille näkyy sertti!

<img width="732" height="134" alt="image" src="https://github.com/user-attachments/assets/6772fda9-410b-4c87-8163-3b0f8cadb68b" />

Kokeilin vielä toisella SSL-testillä, josko jostain syystä SSL Labsin clear cache ei toiminut. 

[Immuniweb.com:in SSL Security Test](https://www.immuniweb.com/ssl/) antaa arvosanan A, ja CAA sertti näkyy myös olevan paikallaan:

<img width="1103" height="1046" alt="image" src="https://github.com/user-attachments/assets/6c4276b0-b75a-4a5b-8eb4-9ca3b0c7bee8" />

<img width="1069" height="249" alt="image" src="https://github.com/user-attachments/assets/300d96f2-24e2-47dd-99fd-5effea8c9217" />


Pitää kokeilla vielä toisena päivä tuota SSL Labsin testiä, josko mun sivun tiedot olisi lähteneet välimuistista. Update: saman päivän illalla (noin 6h myöhemmin) näkyi myös SSL Labs:in testissä CAA voimassa paulcarlson.fi -osoitteessa.

----

# Lähteet

1. Karvinen, T. Linux Palvelimet 2025 alkusyksy. Luettavissa: https://terokarvinen.com/linux-palvelimet/. Luettu: 27.9.2025
2. CloudFlare. What is SSL? | SSL definition. Cloudflare.com. Luettavissa: https://www.cloudflare.com/learning/ssl/what-is-ssl/. Luettu: 27.9.2025.
3. Let's Encrypt. How It Works. Letsencrypt.org. Luettavissa: https://letsencrypt.org/how-it-works/. Luettu: 27.9.2025.
4. Apache. SSL/TLS Strong Encryption: How-To. Apache.org. Luettavissa: https://httpd.apache.org/docs/2.4/ssl/ssl_howto.html. Luettu: 27.9.2025.
5. Qualys, Inc. SSL Server Test (Powered by Qualys SSL Labs). Luettavissa: https://www.ssllabs.com/ssltest/. Luettu: 27.9.2025.
6. Narinen, J. Salataampa verkkoliikennettä. GitHub.com. Luettavissa: https://github.com/narinojanne/linux-homeworks/blob/main/h6-salataampa.md. Luettu: 27.9.2025.
7. ImmuniWeb. SSL Security Test. ImmuniWeb.com. Luettavissa: https://www.immuniweb.com/ssl/. Luettu: 27.9.2025.
