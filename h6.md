# Verkkosivun salaus

Termistöä [Cloufdlaren What is SSL | SSL definition](https://www.cloudflare.com/learning/ssl/what-is-ssl/) -sivulta: 

- SSL = Secure Sockets Layer
  - vanhempi protokolla
- TSL = Transport Layer Security
  - nykyään käytössä
- HTTPS = TSL salattu HTTP

Silti sanotaan usein SSL kun tarkoitetaan TSL, nimi on juurtunut.

Sitten tiivistelmiin.

[Let's Encrypt - How it Works](https://letsencrypt.org/how-it-works/)
- Automatisoi domainin HTTPS-sertifioinnin
- Käyttää ACME-protokollaa maantiekiitäjän nappaa... eikun sertifikaatin luomiseen
- Julkisen avaimen salausta käytetään domainin testaamiseen:
  - Haastaa webbiservun esim. julkaisemaan tietyn koodin domainin alla -> todiste, että sertifikoinnin pyytäjällä on domain hallussaan
  - Useita haasteita eri lähteistä, jotta pyyntöä ei voi kaapata valheellisesti (haasteethan tapahtuvat salaamattoman http-yhteyden kautta, koska https ei ole vielä käytössä)
  - Jos haastet onnistuvat, Let's Encrypt CA (certificate authority) antaa domainin generoidulle julkiselle avaimelle sertifikaatin
  - Sertifikaatti jaetaan vielä julkisesti usealle Certificate Transparency (CT) lokille
- Sertifikaattiketju: pari isoa juuri sertifikaattia autorisoi alempia vasallisertifikaatteja, jotka sertifioivat taas alemmas, ja selain kun luottaa tähän ketjuun, luottaa myös uuden palvelimen sertifikaattiin vaikkei olisi sitä ikinä ennen nähnyt

[Apache.org - SSL/TSL Strong Encryption: How-To](https://httpd.apache.org/docs/2.4/ssl/ssl_howto.html#configexample)
- Minimiconffi:
```
<VirtualHost *:443>
    ServerName www.example.com
    SSLEngine on
    SSLCertificateFile "/path/to/www.example.com.cert"
    SSLCertificateKeyFile "/path/to/www.example.com.key"
</VirtualHost>
```

SSL päälle Name-Based Virtual Hostiin certbotin avulla yksinkertaisuudessaan:

Reikä tulimuuriin:

`sudo ufw allow 443/tcp`

<img width="589" height="495" alt="image" src="https://github.com/user-attachments/assets/80394202-51b8-4ada-b96a-af6248e98ee7" />

Asenna certbot:

`sudo apt-get install certbot python3-certbot-apache`

<img width="989" height="59" alt="image" src="https://github.com/user-attachments/assets/63d682b7-d978-4b09-ad0f-39daedc11f6b" />

Olipa muuten kätevää käyttää tabua, kun kirjoitti tuota komentoa. python3-cer `-TAB-` näyttää mitä on saatavilla repositoriosta:

<img width="946" height="130" alt="image" src="https://github.com/user-attachments/assets/df5f1095-6467-46d2-a5db-b7334a31dd94" />

Sertifioi valitut domainit:

`sudo certbot --apache --domains example.com,www.example.com`

<img width="1166" height="609" alt="image" src="https://github.com/user-attachments/assets/d6234c3e-55e9-4bed-82aa-4a439bb511c5" />

<img width="693" height="174" alt="image" src="https://github.com/user-attachments/assets/cbecc3a7-69fe-4277-b23f-98788fef1476" />

<img width="678" height="149" alt="image" src="https://github.com/user-attachments/assets/adbf54f5-3d96-453b-8240-446e38996c70" />

Ja siellähän se himoittu lukonkuva loistaa!

Ja conffi `/etc/apache2/sites-available/paulcarlson.fi.conf` näyttää certbotin jäljiltä tältä:

```
<VirtualHost *:80>
    ServerName paulcarlson.fi
    ServerAlias www.paulcarlson.fi
    
    DocumentRoot /home/deploy/publicsites/paulcarlson.fi/

    <Directory /home/deploy/publicsites/paulcarlson.fi/>
        Require all granted
    </Directory>
RewriteEngine on
RewriteCond %{SERVER_NAME} =www.paulcarlson.fi [OR]
RewriteCond %{SERVER_NAME} =paulcarlson.fi
RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>
```

Lisäksi kansiossa on nyt ssl-conffi `paulcarlson.fi-le-ssl.conf`:

```
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName paulcarlson.fi
    ServerAlias www.paulcarlson.fi
    
    DocumentRoot /home/deploy/publicsites/paulcarlson.fi/

    <Directory /home/deploy/publicsites/paulcarlson.fi/>
        Require all granted
    </Directory>

Include /etc/letsencrypt/options-ssl-apache.conf
SSLCertificateFile /etc/letsencrypt/live/paulcarlson.fi/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/paulcarlson.fi/privkey.pem
</VirtualHost>
</IfModule>
```

Mitenhän käy sanuli.paulcarlson.fi:n kanssa, kun sen conffi näyttää avain erilaiselta Nginx-käänteisvälityspalvelimen takia:
```
<VirtualHost *:80>
	ServerName sanuli.paulcarlson.fi
	ServerAlias www.sanuli.paulcarlson.fi
	
	# Nginx reverse-proxy settings
	ProxyPass		"/"	"http://localhost:8081/"
	ProxyPassReverse	"/"	"http://localhost:8081/"	

</VirtualHost>
```

