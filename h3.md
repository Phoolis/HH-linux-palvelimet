# Apache Web Server

Lähde: The Apache Software Foundation 2023: Apache HTTP Server Version 2.4 Documentation: [Name-based Virtual Host Support](https://httpd.apache.org/docs/2.4/vhosts/name-based.html)

Tiivistelmä:

- Verrattuna IP:hen perustuviin hosteihin: Name-based virtual host voi hostata montaa eri webbisivua samassa IP-osoitteessa
- Pyynnöt ohjataan ensin `IP:port `perusteella, ja jos tuolla kombinaatiolla löytyy useampi webbisivu, verrataan pyynnön `ServerName` ja `ServerAlias` palvelimelle asetettuihin nimiin
- Fallback: jos pyynnön `ServerName` ja/tai `ServerAlias` ei mätsää palvelimelle asetettuihin, valitaan ensimmäinen virtual host listasta
- `DocumentRoot` kertoo missä hakemistossa webbisivun koodi sijaitsee
- Basic syntax:
    ```
    <VirtualHost *:80>
        # This first-listed virtual host is also the default for *:80
        ServerName www.example.com
        ServerAlias example.com 
        DocumentRoot "/www/domain"
    </VirtualHost>
    
    <VirtualHost *:80>
        ServerName other.example.com
        DocumentRoot "/www/otherdomain"
    </VirtualHost>
    ```
- Useampi `ServerAlias` myös mahdollinen: `ServerAlias example.com *.example.com`
- Huom! Jokerimerkit: `* ?`  

[Tero Karvisen Apache Name Based Virtua Hosts ohje](https://terokarvinen.com/2018/04/10/name-based-virtual-hosts-on-apache-multiple-websites-to-single-ip-address/) 

Tiivistelmä yltä Apachen asennuksen ja konffaamisen peruskomennot:

- Asenna apache2 `sudo apt-get -y install apache2`
- Luo default html-index page polkuun `/var/www/html/index.html`
- Jokaisella webbisivulla (eli name-based virtual hostilla) on oma conffi-tiedostonsa `/etc/apache2/sites-available/pyora.example.com.conf`
- Esimerkki conffi-tiedosto:
    ```
    <VirtualHost *:80>
     ServerName pyora.example.com
     ServerAlias www.pyora.example.com
     DocumentRoot /home/xubuntu/publicsites/pyora.example.com
     <Directory /home/xubuntu/publicsites/pyora.example.com>
       Require all granted
     </Directory>
    </VirtualHost>
    ```
- Laita conffi päälle (julkaise sivu) `sudo a2ensite pyora.example.com`
- Restarttaa apache2 (tämä komento hyvä, sillä se ei aja alas muita jo hostattuja webbisivuja) `sudo systemctl restart apache2`
- Testaus curlilla:  `curl -H 'Host: pyora.example.com' localhost`
- Nimen reititystä voi testata ilman, että tarvitsee ostaa domainia jostain palvelusta, muokkaamalla `hosts` filua:
  ```
    $ sudoedit /etc/hosts
    127.0.0.1 localhost
    127.0.1.1 xubuntu
    127.0.0.1 pyora.example.com
  ```

# Oma webbipalvelin

Webbipalvelin asennettu ohjeiden mukaan. Vastaa `localhost` pyyntöön sekä `curl`:lla että selaimesta:
<img width="1024" height="768" alt="image" src="https://github.com/user-attachments/assets/6a0cc91f-7325-43d6-aaef-a7cd7e7258be" />

Webbipalvelimen lokitiedostot löytyvät polusta `/var/log/apache2`. Komennolla `tail -f` voi seurata logitiedostoon tulevia rivejä reaaliajassa. Alla syntyneet rivit, kun `localhost`-osoitteeseen navigoidaan selaimella, tai otetaan yhteys `curl`:lla:

<img width="1024" height="768" alt="image" src="https://github.com/user-attachments/assets/409e0712-c7fb-4900-a829-63594480113f" />

Lokin selitykset:
- `::1` - IPv6 lyhennetty osoite `localhost`:lle, eli IPv4-osoitteelle `127.0.0.1 ` Lähde: [stackoverflow](https://stackoverflow.com/questions/4611418/what-is-ip-address-1)
- Aika ja aikavyöhyke.
- `GET` - Pyynnön HTTP komento, eli perus gettipyyntö.
- `HTTP/1.1` HTTP-pyynnön versio 1.1
- `200` HTTP-vastauksen koodi, 200 = OK.
- Pyynnön teki `curl`-ohjelma versiolla 8.14.1, tai Mozilla-selain.

# SIVUJUONNE - Hyper-V Enhanced session mode

Käytän windowsin omaa virtualisointia Hyper-V:tä, jonka kanssa mm. copy-paste ei toimi suoraan hostin ja guestin välillä. Lähdin selvittämään, miten sen saisi päälle. Ratkaisun pitäisi olla Hyper-V:n Enhanced Session Mode, joka ottaa Remote Desktop yhteyden guest virtuaalikoneeseen. Sitten vain selvittämään, miten sen saa päälle Debianiin.

Ensimmäisestä [lähteestä](https://www.nakivo.com/blog/install-ubuntu-20-04-on-hyper-v-with-enhanced-session/) löytyi selkeästi kirjoitetut ohjeet ja linkki scriptiin, millä ubuntuun saa Enhanced Session -moodin päälle. Tämä siis Ubuntulle, toisesta [lähteestä](https://gist.github.com/ikr4-m/67023682f949c2c22b0e51d0acb68b05) löytyi modattu scripti Debianille, joka kommenttien mukaan toimisi ainakin Debian 12 versiolle. Lähdin yrittämään sitä edellisen linkin ohjeita seuraten, kohdasta `Post Installation Configuration in Ubuntu` eteenpäin.

Kopsasin `install.sh` bash-scriptin Debianin työpydälle, ja lähdin muuttamaan siitä kohtia, mitkä oli merkitty komnmenteissa. Esim. komnmentoin pois GNOME-työpöytään liittyvän rivin:
```
# If you not using GNOME, remove GNOME_SHELL_SESSION_MODE.
# export GNOME_SHELL_SESSION_MODE=debian
```

Ja sen alle muutin desktopin asetuksen `xfce`:ksi.
```
# Change the XDG_CURRENT_DESKTOP with your default DE/WM
export XDG_CURRENT_DESKTOP=xfce
```

Ajoin scriptin `sudo ./install.sh`
Kohta `cat > /etc/polkit-1/localauthority/50-local.d/45-allow-colord.pkla` tuotti virheen, sillä kansiota `/localauhtority/ `ei löytynyt. Loin kansion ja sille alikansion `50-local.d`, jonka jälkeen scriptin ajettua uudelleen se ei enää herjannut tuosta.

Seuraavaksi kuten scripti ystävällisesti tulosti ruudulle, sammutin virtuaalikoneen ja ajoin scriptin pyytämän komennon PS:ssä.
<img width="640" height="138" alt="kuva" src="https://github.com/user-attachments/assets/3a88386c-9014-4ffe-93f0-bfdc060becb0" />

Näistä ei tullut virheitä, mutta kun yrityn ottaa yhteyden Debianiin Enhanced Session Mode päällä, kirjautumisen jälkeen remote desktop sessio meni aina pimeäksi. Tämän kanssa pähkäilin jonkin aikaa, kunnes sattumalta yhdestä stackoverflow-ketjusta joku keksi mainita [kommenteissa](https://superuser.com/questions/1773172/remote-desktop-cant-connect-to-hyper-v-ubuntu-v22-04-guest#comment2763914_1773174) , että pitää logata käyttäjä ulos ensin ilman Enhanced Session modea, jotta sama käyttäjä ei sitten yritä kirjautua sisään Remote Desktopin kautta.

Tämän jälkeen Remote Desktop yhteys toimi, sain kirjauduttua sisään, ja copy-paste hostin ja guestin välillä toimii!

# Etusivu uusiksi

Hattu-sivun konffaus:

```
phool@paul-debian13:/etc/apache2/sites-available$ cat hattu.example.com.conf 
<VirtualHost *:80>  
  ServerName hattu.example.com  
  ServerAlias www.hattu.example.com 
  DocumentRoot /home/phool/public-sites/hattu.example.com  

  <Directory /home/phool/public-sites/hattu.example.com>  
      Require all granted  
  </Directory>  

  Errorlog ${APACHE_LOG_DIR}/error-hattu.example.log  
  Customlog ${APACHE_LOG_DIR}/access-hattu.example.log combined  
  
</VirtualHost>  
```

Korvataan `/var/www/index.html` omalla webbisivulla, nyt aluksi sanoo vaan "Tämä on sivu hattu.example.com".

<img width="1364" height="867" alt="kuva" src="https://github.com/user-attachments/assets/81d56b77-08c8-4b79-954d-1c4644f8eed9" />

Simppeli html5-sivu:

<img width="1207" height="501" alt="kuva" src="https://github.com/user-attachments/assets/014511a7-c57c-41dc-a535-36871e0eb680" />

