# Palvelimen vuokraminen

Tiivistelmät lähteistä [Susanna Lehto 2022: Teoriasta käytäntöön pilvipalvelimen avulla (h4)](https://susannalehto.fi/2022/teoriasta-kaytantoon-pilvipalvelimen-avulla-h4/) ja Karvinen 2012: [First Steps on a New Virtual Private Server – an Example on DigitalOcean and Ubuntu 16.04 LTS](https://terokarvinen.com/2017/first-steps-on-a-new-virtual-private-server-an-example-on-digitalocean/)

- Vuokrasi yksityisen DigitalOceanin `virtual private server`:in. Näköjään ilmainen GitHub Education -paketin kautta.
- Domaini NameCheap:lta.
- Näköjään aloituskäyttö ilmainen GitHub Education -paketin kautta.
- Droplet = virtuaalipalvelin DigitalOceanin sanastossa.
- Valitsee käyttöjärjestelmän, ja halutun paketin (muisti, cpu, tiedonsiirto), isompi tietenkin kalliimpi. Kuukausimaksu.
- Datakeskuksen valinta läheltä käyttäjää.
- Voi valita SSH-avaimen tai salasanan tunnistautumiseen.
- Yhteys palvelimeen, kun se on asetettu: `ssh root@188.166.4.6`. Tietenkin oman pavelilen IP-osoite tuohon.
- Palomuurin asennus ja konffaus palvelimelle:
 ```
  sudo apt-get install ufw
  sudo ufw allow 22/tpc
  sudo ufw enable
 ```
- Lisää käyttäjä `sudo adduser newusername`, ja tee siitä pääkäyttäjä `sudo adduser newusername sudo`
- Siihen yhteys `ssh newusername@188.166.4.6`
- Lukitse juuri  `sudo usermod –lock root`
- Asenna apache2 edellisviikon ohjeiden mukaan, ja avaa sille portti palomuuriin `sudo ufw allow 80/tcp`
- Palvelimen kaikkien ohjelmien päivittäminen:
 ```
  sudo apt-get update
  sudo apt-get upgrade
  sudo apt-get dist-upgrade
 ```

# Palvelin Hetzneriltä

Päädyin vuokraamaan cloud palvelimen Hetzneriltä, sillä kurssikaverilla on se käytössä sekä omaan että koulujuttujen tarpeisiin, ja ajattelin itsekin pitää palvelimen tämän kurssin jälkeen ja laittaa sinne omia tekeleitä portfoliomielessä työnhakua avittamaan. Sinne on asennettu projektitöistä sitä sun tätä, ja on toiminut hyvin. Plussana heillä on palvelinkeskus myös Suomessa. Halvin shared vCPU olisi alle 5€ kuussa.

<img width="1457" height="592" alt="image" src="https://github.com/user-attachments/assets/ec0986fb-42a0-4d7f-87d6-71131feead81" />

Asiakastilin luomisen ja kirjautumisen jälkeen pääsee hallinnoimaan omia projektejaan:

<img width="949" height="541" alt="image" src="https://github.com/user-attachments/assets/6c997f52-5f2c-4559-b7e3-6891ecbde7a1" />

Klikkaamalla Create Server pääsee valitsemaan halutut speksit ja muut asiat palvelimelle:

<img width="1207" height="782" alt="image" src="https://github.com/user-attachments/assets/e6465fcd-1af8-48b6-bf01-06bac91b599d" />

Ikävä kyllä kaikista halvin vaihtoehto ei ollut valittavana, mutta seuraavaksi halvin jää silti alle sen 5€ kuukaudessa. Käsittääkseni tuo on maksimi, todellisuudessa laskutetaan käytön mukaan.

Päätin yrittää SSH-avaimen luomista pääkäyttäjän salasanan sijaan. Olen sitä aiemmin käyttänytkin, eli pienellä muistin virkistyksellä sen pitäisi onnistua. Käytän apuna Hetznerin ohjetta [Setting up an SSH key](https://community.hetzner.com/tutorials/howto-ssh-key).

Loin ssh-avaimen ensin omalla koneella (eli omalle koneelle asennetussa virtuaali-Debianissa) `ssh-keygen -t ed25519`. Protokollana RSA:ta turvallisempi Ed25519.Openssh-ohjelma piti tietenkin asentaa ensin (pääkäyttäjän oikeuksilla tietysti, hölmö).

<img width="806" height="457" alt="image" src="https://github.com/user-attachments/assets/9b42984b-e38b-4408-a8f1-708821738bfb" />


SSH-avaimen public ja private keyt luotu polkuun `~/.ssh`
<img width="471" height="54" alt="image" src="https://github.com/user-attachments/assets/041717fc-b5ae-4542-b873-c3242739fe59" />


Kopsasin ylläolevan tulosteen (piilotettu) palvelimen asetuksiin:
<img width="1006" height="579" alt="image" src="https://github.com/user-attachments/assets/411cf4ff-e6b8-4027-86b9-4cad56399699" />

Säilytystila on näköjään vielä extraa:
<img width="967" height="761" alt="image" src="https://github.com/user-attachments/assets/326912bc-3566-46f6-93e4-932a28098fc4" />

Firewalls, Backups, Placement groups, Labels, nämä jätin vielä tyhjäksi. Nämä varmaan selvenee myöhemmin.

<img width="1551" height="748" alt="image" src="https://github.com/user-attachments/assets/59037a4d-ca96-49f4-bc32-99d6d2a740fd" />

Hyvältä näyttää (jos jättää huomiotta Unknown Error Occurred -varoituksen sivun alaosasta). Piilotin kuvasta ip-osoitteen toistaiseksi.

<img width="1452" height="739" alt="image" src="https://github.com/user-attachments/assets/c5428430-747b-49ea-9b51-bd45fbabc17e" />

-----

Avasin ssh-yhteyden palvelimeen `ssh root@65.109.175.125`.
Lisäsin käyttäjän `sudo adduser phool`.
Käyttäjälle pääkäyttäjän oikeudet `sudo adduser phool sudo`.

TÄssä kohtaa meni väärin! Lukitsin root-käyttäjän ennekuin lisäsin ssh-avaimen myös tälle uudelle käyttäjälle.
Ulos pääkäyttäjänä ja sisään uutena käyttäjänä: `exit` ja uusi yhteys `ssh phool@65.109.175.125`.
Olisi pitänyt havaita virheeni, kun `phool`:lla ssh-yhteyden luomisessa kysyttiin salasanaa.
Menin joka tapauksessa heti eteenpäin ja lukitsin juurikäyttäjän salasanan: `sudo usermod --lock root`, ja ssh-yhteyden `sudoedit /etc/ssh/sshd_config` ja sieltä `PermitRootLogin no`. `sudo service ssh restart`. Tämän jälkeen roottikäyttäjällä ei voi hallita enää palvelinta, vaan pääkäyttäjän toimin vain minä `phool` -käyttäjällä. Olisi kuitenkin kiva käyttää ssh-avainta, eikä salasanaa sisäänkirjautumiseen.
Onneksi [Hetznerin ssh-ohjeissa](https://community.hetzner.com/tutorials/howto-ssh-key#option-1) oli vinkki miten lisätä ssh-avain uudelle käyttäjälle. Virtuaali debianista voi kopioida ssh-avaimet palvelimelle komennolla `ssh-copy-id`:

`ssh-copy-id phool@65.109.175.125`

Nyt sisäänkirjautuessa ssh-yhteydellä salasanaa ei enää kysytä, vaan käytetään ssh-avainta.

-----

Webbisivu pystyssä osoitteessa `65.109.175.125`. Seuraavalla tunnilla vissiin hommataan sille oma domaini. Mutta nyt loppui aika. ~~Koitan paremmalla ajalla uudelleen kirjoittaa kadonneen osion palvelimen käyttäjien ja ssh-avaimen asetuksista.~~ Kirjoitin lyhyesti tästä yllä.
<img width="1064" height="526" alt="image" src="https://github.com/user-attachments/assets/9e04d5c7-876f-4eff-8a69-410128174470" />

