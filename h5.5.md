# CI/CD-putki kotisivun automaattiseen päivittämiseen

Ajatuksena automatisoida kotisivujen päivitys GitHub Actionsin avulla. Lyhyesti stepit:

- [x] Webbisivun koodi julkiseen git-repoon GitHubiin (https://github.com/Phoolis/paulcarlson.fi). Julkisen repon ajatuksena on se, ettei palvelimelle tarvitse antaa mitään oikeuksia GitHub-tilille.  Tukee kotisivun ideaa julkisena portfoliona.
- [ ] Luo uusi käyttäjä palvelimelle, mutta anna sille minimioikeudet vain kotisivujen päivittämiseen.
  - [x] Käyttäjä `deploy` luotu palvelimelle.
  - [ ] Minimoi oikeudet.
- [x] Kloonaa repo palvelimelle.
- [ ] Tee repoon GitHub Actions -workflow.
- [ ] Lisää worflow:lle käyttäjän SSH-avain.
- [x] Profit.

## Deploy-käyttäjän luominen palvelimella

Luo minimikäyttäjä ilman salasanaa ja käyttäjätietoja:

`sudo adduser --disabled-password --gecos "" deploy`

Anna sille oikeudet `/var/www/html` -kansioon. Päätin nyt pitää webbisivujen pääsivun edelleen tuolla.

`sudo chown -R deploy:deploy /var/www/html`

Luo `deploy`-käyttäjälle SSH-avain. Nämä komennot tulee tehdä pääkäyttäjän oikeuksilla.

```
sudo mkdir -p /home/deploy/.ssh
sudo cp ~/.ssh/authorized_keys /home/deploy/.ssh/
sudo chown -R deploy:deploy /home/deploy/.ssh
sudo chmod 700 /home/deploy/.ssh
sudo chmod 600 /home/deploy/.ssh/authorized_keys
```

Tsekataan, mihin uusi käyttäjä pystyy:

`sudo -i -u deploy`

<img width="649" height="342" alt="image" src="https://github.com/user-attachments/assets/25de38a8-cebc-4d53-a96e-38466a2e4848" />

Pääsee ainakin liikkumaan hakemistopuussa. Se vähän pelottaa: vaikka käyttäjä ei pääsisi lukemaan tiedostoja, voi saada selville mitä missäkin on. Yritän laittaa `deploy`:lle tiukemmat rajoitukset rajoittamalla mitä shelliä se voi käyttää. `nologin`-shellin ei pitäisi kyetä muutakuin ssh, scp ja ftp yhteyksiin (lähde: https://www.linkedin.com/posts/mdshafiur_linux-cybersecurity-systemadministration-activity-7342092497843601408-RdCE/). Koitetaan:

<img width="816" height="467" alt="image" src="https://github.com/user-attachments/assets/d09d3a6c-9b6e-41ea-87cc-58d234a885fa" />

Pari hutia, mutta `sudo tee` pelasti päivän. Eli yllä sudo echo ajettiin kyllä pääkäyttäjän oikeuksilla, mutta seuraavaa append komentoa ei. Toimii toisin päin: `echo` ei vaadi mitään oikeuksia, ja putkeen perään `sudo tee`.

Näyttäisi tepsivän: <img width="539" height="60" alt="image" src="https://github.com/user-attachments/assets/f2f0e733-eaa7-4098-a922-1a82bfa7f2a5" />

Toisaalta nyt ei toimi edes scp: <img width="857" height="80" alt="image" src="https://github.com/user-attachments/assets/46caaa1e-d3e2-4825-8ce6-776f25dd1dea" />

Olikohan tämä taas jotain AI-hallusinaatioita, vai teinkö jotain väärin? No kokeillaan toisella tapaa: `git-shell`-komentotulkilla pitäisi olla hyvin rajattu käyttö (https://git-scm.com/docs/git-shell). Laitetaan se `deploy`-käyttäjän shelliksi `nologin`-shellin sijaan.

----

Tässä välissä oli hirveää säätöä monen eri asian kanssa. Päädyin pitämään `deploy`-käyttäjällä perus bashin. Täytyy palata tähän käyttäjän rajoittamiseen myöhemmin uudelleen. Mutta mahdollisia apuja voisi olla `rbash` (restricted bash) https://www.baeldung.com/linux/restrict-user-one-directory, tai https://unix.stackexchange.com/questions/208960/how-to-restrict-a-user-to-one-folder-and-not-allow-them-to-move-out-his-folder. 

----

Loin git-repon palvelimelle polkuun `/var/www/html` ja liitin yhdistin sen githubin remote repositorioon. Ensin piti lisätä kuitenkin pääkäyttäjälleni oikeudet takaisin:`
sudo setfacl -R -m u:phool:rwx .`

Sitten:

```
git init
git branch -m main
git remote add origin https://github.com/Phoolis/paulcarlson.fi.git
git branch --set-upstream-to=origin/main main
```

Paljon vähemmällä olisi päässyt perus `git clone` -komennolla, mutta nyt tuli tehtyä näin.



