# CI/CD-putki kotisivun automaattiseen päivittämiseen

Ajatuksena automatisoida kotisivujen päivitys GitHub Actionsin avulla. Lyhyesti stepit:

- [x] Webbisivun koodi julkiseen git-repoon GitHubiin (https://github.com/Phoolis/paulcarlson.fi). Julkisen repon ajatuksena on se, ettei palvelimelle tarvitse antaa mitään oikeuksia GitHub-tilille.  Tukee kotisivun ideaa julkisena portfoliona.
- [ ] Luo uusi käyttäjä palvelimelle, mutta anna sille minimioikeudet vain kotisivujen päivittämiseen.
  - [x] Käyttäjä `deploy` luotu palvelimelle.
  - [ ] Minimoi oikeudet.
- [x] Kloonaa repo palvelimelle.
- [x] Tee repoon GitHub Actions -workflow.
- [x] Lisää worflow:lle käyttäjän SSH-avain.
- [x] Profit.

## Deploy-käyttäjän luominen palvelimella

Luo minimikäyttäjä ilman salasanaa ja käyttäjätietoja:

`sudo adduser --disabled-password --gecos "" deploy`

Anna sille oikeudet `/var/www/html` -kansioon. Päätin nyt pitää webbisivujen pääsivun edelleen tuolla.

`sudo chown -R deploy:deploy /var/www/html`

Luo `deploy`-käyttäjälle SSH-avain. Nämä komennot tulee tehdä pääkäyttäjän oikeuksilla.

```bash
sudo mkdir -p /home/deploy/.ssh
sudo cp ~/.ssh/authorized_keys /home/deploy/.ssh/
sudo chown -R deploy:deploy /home/deploy/.ssh
sudo chmod 700 /home/deploy/.ssh
sudo chmod 600 /home/deploy/.ssh/authorized_keys
```

Tsekataan, mihin uusi käyttäjä pystyy:

`sudo -i -u deploy`

<img width="649" height="342" alt="image" src="https://github.com/user-attachments/assets/25de38a8-cebc-4d53-a96e-38466a2e4848" />

Pääsee ainakin liikkumaan hakemistopuussa. Se vähän pelottaa: vaikka käyttäjä ei pääsisi lukemaan tiedostoja, voi saada selville mitä missäkin on. Yritän laittaa `deploy`:lle tiukemmat rajoitukset rajoittamalla mitä shelliä se voi käyttää. `nologin`-shellin ei pitäisi kyetä muutakuin ssh, scp ja ftp yhteyksiin (lähde: https://www.linkedin.com/posts/mdshafiur_linux-cybersecurity-systemadministration-activity-7342092497843601408-RdCE/). Koitetaan:

<img width="816" height="467" alt="image" src="https://github.com/user-attachments/assets/d09d3a6c-9b6e-41ea-87cc-58d234a885fa" />

Pari hutia, mutta `sudo tee` pelasti päivän. Eli yllä sudo echo ajettiin kyllä pääkäyttäjän oikeuksilla, mutta seuraavaa append komentoa ei. Toimii toisin päin: `echo` ei vaadi mitään oikeuksia, ja putkeen perään `sudo tee`.

Näyttäisi tepsivän: <img width="539" height="60" alt="image" src="https://github.com/user-attachments/assets/f2f0e733-eaa7-4098-a922-1a82bfa7f2a5" />

Toisaalta nyt ei toimi edes scp: <img width="857" height="80" alt="image" src="https://github.com/user-attachments/assets/46caaa1e-d3e2-4825-8ce6-776f25dd1dea" />

Olikohan tämä taas jotain AI-hallusinaatioita, vai teinkö jotain väärin? No kokeillaan toisella tapaa: `git-shell`-komentotulkilla pitäisi olla hyvin rajattu käyttö (https://git-scm.com/docs/git-shell). Laitetaan se `deploy`-käyttäjän shelliksi `nologin`-shellin sijaan.

----

Tässä välissä oli hirveää säätöä monen eri asian kanssa. Päädyin pitämään `deploy`-käyttäjällä perus bashin. Täytyy palata tähän käyttäjän rajoittamiseen myöhemmin uudelleen. Mutta mahdollisia apuja voisi olla `rbash` (restricted bash) https://www.baeldung.com/linux/restrict-user-one-directory, tai https://unix.stackexchange.com/questions/208960/how-to-restrict-a-user-to-one-folder-and-not-allow-them-to-move-out-his-folder. 

----

Loin git-repon palvelimelle polkuun `/var/www/html` ja yhdistin sen githubin remote repositorioon. Ensin piti lisätä kuitenkin pääkäyttäjälleni oikeudet takaisin:`
sudo setfacl -R -m u:phool:rwx .`

Sitten:

```bash
git init
git branch -m main
git remote add origin https://github.com/Phoolis/paulcarlson.fi.git
git branch --set-upstream-to=origin/main main
```

Paljon vähemmällä olisi päässyt perus `git clone` -komennolla, mutta nyt tuli tehtyä näin.

## GitHub Workflow for deployment

Nyt kun palvelimen repo on liitetty github:n remote repositorioon, voin tehdä muutoksia sinne mistä vain. Kloonasin `paulcarlson.fi`-repon omalle koneelle ja hoidin hommia sitten vscode:lla.

Loin repositorion juureen kansion `.github`, sille alikansion `worklows`, ja sinne `deploy.yml`-tiedoston:

<img width="345" height="136" alt="image" src="https://github.com/user-attachments/assets/e870ff50-ac89-4e01-b943-19495b9188f9" />

Workflow-tiedostojen luomista oltiin juuri käyty DevOps-kurssilla. Nyt halusin luoda simppelin workflown, missä luodaan SSH-yhteys palvelimelle `deploy`-käyttäjällä, mennään `/var/www/html`-kansioon, ja pullataan sinne uusimmat muutokset:

```yml
name: Deploy Website
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd /var/www/html
            git fetch --all
            git reset --hard origin/main
```

Valmiita Actioneita löytyy github marketplacesta https://github.com/marketplace?type=actions. SSH-action (https://github.com/appleboy/ssh-action) on yksinkertainen ja turvallinen actioni SSH-yhteyden luontiin palvelimelle. Se käyttää GitHubiin säilöttyjä salaisuuksia SSH-yhteyden luomiseen. Salaisuudet voi säilöä Settings -> Secrets and variables -> Repository secrets:

<img width="1116" height="339" alt="image" src="https://github.com/user-attachments/assets/4c3b5304-69c1-4ae0-bd6a-02cd26721f49" />

Tässä piti olla tarkkana yksityisen SSH-avaimen kopioinnissa kenttään: multa jäi lopun rivinvaihto kopioimatta, ja SSH-avain ei sitten toiminut. Tämän selvittämisessä meni hyvä tovi. Eli koko tiedoston sisältö pitää olla kopioituna, sisältäen myös alun `-----BEGIN OPENSSH PRIVATE KEY-----` ja lopun `----END OPENSSH PRIVATE KEY-----`, ja lopussa oleva rivinvaihto!

DEPLOY_HOST = `65.109.175.125`
DEPLOY_USER = `deploy`
DEPLOY_KEY = _yllä mainittu rimpsu kokonaisuudessaan_

`script`: komennot, mitä ssh-yhteyden luonnin jälkeen ajetaan. Tässä vain navigoidaan oikeaan polkuun ja tehdään `git pull` (tai oikeammin tuhoavampi versio siitä, jos jostain syystä hakemistoon on tehty muutoksia joita ei löydy remote repositoriosta). Pipe `|` = multi-line syntax https://www.baeldung.com/yaml-multi-line.

## Webbisivun kansion siirto oikeaan paikkaan

Tähän asti työstänyt ja julkaissut pääsivuni paulcarlson.fi kansiosta `/var/www/html`. Olisi parempi, jos tuolla olisi vain simppeli index.html jota käytetään vain poikkeustilanteissa. Siirrän itse kotisivujen kansion deploy-käyttäjän kotihakemistoon `/home/deploy/publicsites/`. Täytyy myös laittaa git-repo osoittamaan sinne.

Alkutilanne:

<img width="676" height="388" alt="image" src="https://github.com/user-attachments/assets/bf30a7d4-939c-41ec-bd5a-a90cce6b6a82" />

Täällä ei ole mitään mitä ei ole julkisessa git-repossa, joten voin surutta poistaa ja luoda simppelin text-only index.html-sivun. `sudo rm -r /var/www/html`, tilalle `echo "Paulin kotisivut. Paul's homepage." | sudo tee index.html`.

<img width="565" height="90" alt="image" src="https://github.com/user-attachments/assets/8024db50-24be-4734-8a3f-4404713bc9b5" />

Toimii. Sitten pystyttämään git-repoa oikeaan paikkaan.

Tehdään kansio ja sille oikeudet (nämä pääkäyttäjänä), ja lisätään pääkäyttäjä ryhmään `deploy`:

```
sudo mkdir -p /home/deploy/publicsites
sudo chown deploy:deploy /home/deploy/publicsites
sudo usermod -aG deploy phool
```

Välissä tulee logata ulos ja sisään. SSH-yhteydellä siis `exit` ja luoda ssh-yhteys uudelleen.

Laitetaan vielä group bitti päälle, eli kansioon kaikki luodut filut ja alikansiot perivät yläkansiolta group-oikeudet:

`sudo chmod g+s /home/deploy/publicsites`

Kloonataan git-repo sinne: `git clone https://github.com/Phoolis/paulcarlson.fi.git`. Tehdään deploy samalla kun muokataan workflow filuun oikea polku:

Deploy.yml filuun scriptin kohdalle:
```
  script: |
    cd /home/deploy/publicsites/paulcarlson.fi
    git fetch --all
    git reset --hard origin/main
```

Commitin jälkeen tsekkasin, että `/home/deploy/publicsites/paulcarlson.fi/` hakemistoon oli tullut sisältöä, ja olihan sinne. Deploy successful.

Vielä conffi-filuun oikea polku ja saitti päälle, `sudo a2ensite paulcarlson.fi.conf` ja `sudo systemctl restart apache2`.

```
<VirtualHost *:80>
    ServerName paulcarlson.fi
    ServerAlias www.paulcarlson.fi
    
    DocumentRoot /home/deploy/publicsites/paulcarlson.fi/

    <Directory /home/deploy/publicsites/paulcarlson.fi/>
        Require all granted
    </Directory>
</VirtualHost>
```
Forbidden. Varmaankin koska olin luonut `/home/deploy/publicsites` -kansion `sudo` komennolla, apachella ei ole oikeuksia kulkea kansioissa. Piti lisätä ne `sudo chmod o+x /home/deploy`.

Nyt toimii taas.


